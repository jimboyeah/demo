<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title> Hello BizCharts for React! </title>
        <script src="../js/react.development.js"> </script>
        <script src="../js/react-dom.development.js"> </script>
        <script src="../js/babel.min.js"> </script>
        <script src="../js/BizCharts-3.3.0.min.js"></script>
        <script src="../js/data-set.min.js"></script>
        <script src="../js/jquery.min.js"></script>
        <!-- 
        <script src="../js/bizcharts-plugin-slider.js"></script>
        <script src="../js/numeral.min.js"></script>
        <script src="../js/polyfill.min.js"></script>
        <script src="https://unpkg.com/bizcharts-plugin-slider@2.0.0/umd/bizcharts-plugin-slider.js"></script>
        <script src="https://cdn.staticfile.org/react/16.4.0/umd/react.development.js"> </script> 
        <script src="https://cdn.staticfile.org/react-dom/16.4.0/umd/react-dom.development.js"> </script>
        <script src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js"> </script>
        <script src="https://unpkg.com/bizcharts@3.3.4/umd/BizCharts.min.js"></script>
        -->
        <link rel="stylesheet" href="theme.css">
        <style>#example { background:_white; }</style>
        <script>
            document.onclick = function(e){
                // document.body.className = document.body.className?"":"half" 
                render();
            }
        </script>
    </head>
    <body class="half">
        <div id="example"> </div>
        <script src="./utils.js"> </script>

    </body>
</html>

<script type="text/babel">
    // import {Component} from 'react';
    let Component = React.Component;
    
    // import { Chart, Axis, Legend, Tooltip, Geom } from 'bizcharts';
    // bizUtil.setTheme('dark');
    BizCharts.setTheme('dark');

    var 
    Axis = BizCharts.Axis,
    Chart = BizCharts.Chart,
    Coord = BizCharts.Coord,
    Facet = BizCharts.Facet,
    G2 = BizCharts.G2,
    Geom = BizCharts.Geom,
    Guide = BizCharts.Guide,
    Label = BizCharts.Label,
    Legend = BizCharts.Legend,
    Line = BizCharts.Line,
    Shape = BizCharts.Shape,
    Tooltip = BizCharts.Tooltip,
    Util = BizCharts.Util,
    View = BizCharts.View;
</script>

<script type="text/babel">
// import React from "react";
// import {G2, Chart, Geom, Axis, Tooltip, Coord, Label, Legend, View, Guide, Shape, Facet, Util } from "bizcharts";

class Waterfall extends React.Component {
  render() {
    function getRectPath(points) {
      const path = [];

      for (let i = 0; i < points.length; i++) {
        const point = points[i];

        if (point) {
          const action = i === 0 ? "M" : "L";
          path.push([action, point.x, point.y]);
        }
      }

      const first = points[0];
      path.push(["L", first.x, first.y]);
      path.push(["z"]);
      return path;
    }

    function getFillAttrs(cfg) {
      const defaultAttrs = Shape.interval;
      const attrs = Util.mix(
        {},
        cfg.style,
        defaultAttrs,
        {
          fill: cfg.color,
          stroke: cfg.color,
          fillOpacity: cfg.opacity,
        }
      );
      return attrs;
    }

    Shape.registerShape("interval", "waterfall", {
      draw(cfg, container) {
        const attrs = getFillAttrs(cfg);
        let rectPath = getRectPath(cfg.points);
        rectPath = this.parsePath(rectPath);
        const interval = container.addShape("path", {
          attrs: Util.mix(attrs, {
            path: rectPath
          })
        });

        if (cfg.nextPoints) {
          let linkPath = [
            ["M", cfg.points[2].x, cfg.points[2].y],
            ["L", cfg.nextPoints[0].x, cfg.nextPoints[0].y]
          ];

          if (cfg.nextPoints[0].y === 0) {
            linkPath[1] = ["L", cfg.nextPoints[1].x, cfg.nextPoints[1].y];
          }

          linkPath = this.parsePath(linkPath);
          container.addShape("path", {
            attrs: {
              path: linkPath,
              stroke: "rgba(0, 0, 0, 0.45)",
              lineDash: [4, 2]
            }
          });
        }

        return interval;
      }
    });
    const data = [
      {type: "日用品", money: 300 },
      {type: "伙食费", money: 900 },
      {type: "交通费", money: 200 },
      {type: "水电费", money: 300 },
      {type: "房租", money: 1200 },
      {type: "商场消费", money: 1000 },
      {type: "应酬交际", money: 2000 },
      {type: "总费用", money: 5900 }
    ];

    for (let i = 0; i < data.length; i++) {
      const item = data[i];

      if (i > 0 && i < data.length - 1) {
        if (Util.isArray(data[i - 1].money)) {
          item.money = [
            data[i - 1].money[1],
            item.money + data[i - 1].money[1]
          ];
        } else {
          item.money = [data[i - 1].money, item.money + data[i - 1].money];
        }
      }
    }

    return (
      <div>
        <Chart height={getRootHeight()} padding={[40, 30, 110, 70]} data={data} forceFit>
          <Legend
            custom={true}
            clickable={false}
            items={[
              {value: "各项花销", marker: {symbol: "square", fill: "#1890FF", radius: 5 } },
              {value: "总费cd用", marker: {symbol: "square", fill: "#8c8c8c", radius: 5 } }
            ]}
          />
          <Axis name="type" />
          <Axis name="money" />
          <Tooltip
            containerTpl='<div class="g2-tooltip">
              <div class="g2-tooltip-title" style="color:black;margin:10px 0;"></div>
              <ul class="g2-tooltip-list" style="color:black;"></ul>
            </div>' />

          <Geom
            type="edge"
            position="type*money"
            color={[
              "type",
              type => {
                if (type === "总费用") {
                  return "rgba(0, 0, 0, 0.65)";
                }

                return "#1890FF";
              }
            ]}
            tooltip={[
              "type*money",
              (type, money) => {
                if (Util.isArray(money)) {
                  return {
                    name: "生活费",
                    value: money[1] - money[0]
                  };
                }

                return {
                  name: "生活费",
                  value: money
                };
              }
            ]}
            shape="waterfall"
          />
        </Chart>
      </div>
    );
  }
}

// ReactDOM.render(<Waterfall />, mountNode)

// export default Waterfall;

</script>


<script type="text/babel">
    const root = document.getElementById('example')
    function getRootHeight(){ //window.innerHeight
        let height = window.getComputedStyle(root).height;
        console.log("getComputedStyle", height, this);
        return parseInt(height);
    }
    function render(){
        ReactDOM.render(
            <Waterfall /> , root
        );
    }
    window.onresize = function(e){
        render();
    }
    render();
</script>