<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title> Hello BizCharts for React! </title>
        <script src="../js/react.development.js"> </script>
        <script src="../js/react-dom.development.js"> </script>
        <script src="../js/babel.min.js"> </script>
        <script src="../js/BizCharts.min.js"></script>
        <script src="../js/data-set.min.js"></script>
        <script src="../js/jquery.min.js"></script>
        <script src="https://unpkg.com/bizcharts-plugin-slider@2.0.0/umd/bizcharts-plugin-slider.js"></script>

        <!-- 
        <script src="../js/bizcharts-plugin-slider.js"></script>
        <script src="../js/numeral.min.js"></script>
        <script src="../js/polyfill.min.js"></script>
        <script src="https://cdn.staticfile.org/react/16.4.0/umd/react.development.js"> </script> 
        <script src="https://cdn.staticfile.org/react-dom/16.4.0/umd/react-dom.development.js"> </script>
        <script src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js"> </script>
        <script src="https://unpkg.com/bizcharts@3.3.0/umd/BizCharts.min.js"></script>
        -->
        <link rel="stylesheet" href="theme.css">
        <style>#example { background:_white; }</style>
        <script>

            document.onclick = function(e){
                // document.body.className = document.body.className?"":"half" 
                render();
            }
        </script>
    </head>
    <body class="half">
        <div id="example"> </div>
        <script src="./utils.js"> </script>

    </body>
</html>

<script type="text/babel">
    // import {Component} from 'react';
    let Component = React.Component;
    
    // import { Chart, Axis, Legend, Tooltip, Geom } from 'bizcharts';
    // bizUtil.setTheme('dark');
    BizCharts.setTheme('dark');

    var 
    Axis = BizCharts.Axis,
    Chart = BizCharts.Chart,
    Coord = BizCharts.Coord,
    Facet = BizCharts.Facet,
    G2 = BizCharts.G2,
    Geom = BizCharts.Geom,
    Guide = BizCharts.Guide,
    Label = BizCharts.Label,
    Legend = BizCharts.Legend,
    Line = BizCharts.Line,
    Shape = BizCharts.Shape,
    Tooltip = BizCharts.Tooltip,
    Util = BizCharts.Util,
    View = BizCharts.View;
</script>

<script type="text/babel">
// import $ from "jquery";
// import React from "react";
// import {G2, Chart, Geom, Axis, Tooltip, Coord, Label, Legend, View, Guide, Shape, Facet, Util } from "bizcharts";
// import DataSet from "@antv/data-set";
// import Slider from "bizcharts-plugin-slider";

let data;
$.ajax({
  url: "https://alifd.alibabausercontent.com/materials/@bizcharts/candlestick-basic/0.3.2/mock.json",
  async : false,
  success: (iData) => { data = iData }
});

function getComponent(data) {
  const { DataView } = DataSet;
  const cols = {
    time:   { type: "timeCat", nice: false, range: [0, 1] },
    trend:  {values: ["上涨", "下跌"] },
    volumn: {alias: "成交量"},
    start:  {alias: "开盘价"},
    end:    {alias: "收盘价"},
    max:    {alias: "最高价"},
    min:    {alias: "最低价"},
    range:  {alias: "股票价格"}
  };
  // 设置状态量，时间格式建议转换为时间戳，转换为时间戳时请注意区间
  const ds = new DataSet({
    state: {
      start: "2015-04-07",
      end: "2015-07-28"
    }
  });
  const dv = ds.createView();
  dv.source(data)
    .transform({
      type: "filter",
      callback: obj => {
        const date = obj.time;
        return date <= ds.state.end && date >= ds.state.start;
      }
    })
    .transform({
      type: "map",
      callback: obj => {
        obj.trend = obj.start <= obj.end ? "上涨" : "下跌";
        obj.range = [obj.start, obj.end, obj.max, obj.min];
        return obj;
      }
    });

  class SliderChart extends React.Component {
    onChange(obj) {
      const { startText, endText } = obj;
      ds.setState("start", startText);
      ds.setState("end", endText);
    }

    render() {
      let height = getRootHeight(); // window.innerHeight
      return (
        <div>
          <Chart
            height={height}
            animate={false}
            padding={[40, 40, 60, 40]}
            data={dv}
            scale={cols}
            forceFit
          >
            <Legend offset={20} />
            <Tooltip
              showTitle={false}
              itemTpl="<li data-index={index}><span style=&quot;background-color:{color};&quot; class=&quot;g2-tooltip-marker&quot;></span>{name}{value}</li>"
            />
            <View
              end={{
                x: 1,
                y: 0.5
              }}
              data={dv}
            >
              <Axis name="time" />
              <Axis name="range" />
              <Geom
                type="schema"
                position="time*range"
                color={[
                  "trend",
                  val => {
                    if (val === "上涨") {
                      return "#f04864";
                    }

                    if (val === "下跌") {
                      return "#2fc25b";
                    }
                  }
                ]}
                tooltip={[
                  "time*start*end*max*min",
                  (time, start, end, max, min) => {
                    return {
                      name: time,
                      value:
                        '<br><span style="padding-left: 16px">开盘价：' +
                        start +
                        "</span><br/>" +
                        '<span style="padding-left: 16px">收盘价：' +
                        end +
                        "</span><br/>" +
                        '<span style="padding-left: 16px">最高价：' +
                        max +
                        "</span><br/>" +
                        '<span style="padding-left: 16px">最低价：' +
                        min +
                        "</span>"
                    };
                  }
                ]}
                shape="candle"
              />
            </View>
            <View
              start={{
                x: 0,
                y: 0.65
              }}
              data={dv}
              scale={{
                volumn: {
                  tickCount: 2
                }
              }}
            >
              <Axis
                name="volumn"
                label={{
                  formatter: function(val) {
                    return parseInt(val / 1000, 10) + "k";
                  }
                }}
              />
              <Axis name="time" tickLine={null} label={null} />
              <Geom
                type="interval"
                position="time*volumn"
                color={[
                  "trend",
                  val => {
                    if (val === "上涨") {
                      return "#f04864";
                    }

                    if (val === "下跌") {
                      return "#2fc25b";
                    }
                  }
                ]}
                tooltip={[
                  "time*volumn",
                  (time, volumn) => {
                    return {
                      name: time,
                      value:
                        '<br/><span style="padding-left: 16px">成交量：' +
                        volumn +
                        "</span><br/>"
                    };
                  }
                ]}
                shape="candle"
              />
            </View>
          </Chart>
        </div>
      );
          // <div>
          //   <Slider
          //     padding={[20, 40, 20, 40]}
          //     width="auto"
          //     height={26}
          //     start={ds.state.start}
          //     end={ds.state.end}
          //     xAxis="time"
          //     yAxis="volumn"
          //     scales={{
          //       time: {
          //         type: "timeCat",
          //         nice: false
          //       }
          //     }}
          //     data={data}
          //     onChange={this.onChange.bind(this)}
          //   />
          // </div>
    }
  }
  return SliderChart;
}

class Basic extends React.Component {
  render() {
    const SliderChart = getComponent(data);
    return (
        <SliderChart />
    );
  }
}

// ReactDOM.render(<Basic />, mountNode)



</script>


<script type="text/babel">
    const root = document.getElementById('example')
    function getRootHeight(){
        let height = window.getComputedStyle(root).height;
        console.log("getComputedStyle", height, this);
        return parseInt(height);
    }
    function render(){
        ReactDOM.render(
            <Basic /> , root
        );
    }
    window.onresize = function(e){
        render();
    }
    render();
</script>